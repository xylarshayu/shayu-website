---
import Layout from '@layouts/Layout.astro';
import { type insertStatus } from '@db/schema';
import { checkLoggedIn } from '@lib/auth';
import StatusForm from '@components/statusForm.svelte';

const { isLoggedIn, toRedirect } = await checkLoggedIn(Astro.cookies);
if (!isLoggedIn) return Astro.redirect(toRedirect);

let status: insertStatus = {
  text: '',
  theme: 'light',
  mood: 'neutral',
  spotify_link: '',
};
let mode: 'create' | 'update' = 'create';
const statusId = Astro.url.searchParams.get('id');
const getLatest = Astro.url.searchParams.get('latest') === 'true';
if (getLatest) {
  const response = await fetch(Astro.url.origin + '/api/status.json');
  if (response.status === 200) {
    status = await response.json();
    mode = 'update';
  }
}
else if (statusId?.length) {
  const response = await fetch(Astro.url.origin + '/api/status/' + statusId + '.json');
  if (response.status === 200) {
    status = await response.json();
    mode = 'update';
  }
};
---

<Layout title="Make a new post">
  <main class="flex flex-col items-center w-[90%] md:w-[70%] mx-auto pt-10vh h-screen gap-1">
    <h1 class="h2 text-primary-100">
      Make a new post
    </h1>
    <div class="my-3">
      <a href="/" class="underline italic cursor-pointer">Or Go Home üè†</a>
    </div>
    <StatusForm {status} mode={mode} class="w-full" client:load />
  </main>
</Layout>